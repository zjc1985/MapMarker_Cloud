function MapMarkerModel(){function f(c,f){var i,j,k,l,m,n,h=new Array;if(0!=a.length){for(i in a)h.push(a[i].toJSONObject());if(j=new Array,0==b.length)k=d.genUUID(),l=new MapMarker(k),l.content.setIsAvergeOverViewMarker(!0),m=g(),l.content.updateContent(m),j.push(l.toJSONObject());else for(i in b)n=b[i],n.content.isAvergeOverViewMarker()&&n.content.updateContent(g()),j.push(n.toJSONObject());e.saveRoutine(c,JSON.stringify(h),JSON.stringify(j),function(){f()})}else f()}function g(){var e,f,g,b=0,c=0,d=0;for(e=0;e<a.length;e++)a[e].isSubMarker()||(c+=a[e].getContent().getLat(),d+=a[e].getContent().getLng(),b++);return f=c/b,g=d/b,{lat:f,lng:g}}function h(b){var d,c=a.length;for(d=0;c>d;d++)if(a[d].id==b)return a[d];return null}function i(a){null!=a.connectedMainMarker&&(null!=a.connectedMainLine&&view.removeById(a.connectedMainLine.id),a.connectedMainLine=new MainLine(view.drawMainLine(a.id,a.connectedMainMarker.id)))}function j(a){for(var b in a.subMarkersArray)view.removeById(a.subMarkersArray[b].line.id),a.subMarkersArray[b].line=new SubLine(view.drawSubLine(a.id,a.subMarkersArray[b].entity.id))}var a=new Array,b=new Array,c=new Array,d=this,e=new BackendManager;this.isOvMarker=function(a){for(var b in c)if(c[b].id==a)return!0;return!1},this.findAverageOvMarkerByOvId=function(a){var e,b=d.getMapMarkerById(a);for(e in c)if(b.routineId==c[e].routineId&&c[e].content.isAvergeOverViewMarker())return c[e];return null},this.getCurrentOverviewMarkers=function(){return b},this.setCurrenOverviewMarkersByOverviewId=function(a){var d,e;b=new Array,d=this.getMapMarkerById(a).routineId;for(e in c)c[e].routineId==d&&b.push(c[e])},this.getAllOverviewMarkers=function(){return c},this.genUUID=function(){return uuid.v4()},this.deleteRoutineByOverviewId=function(a,b){e.deleteRoutineByOverviewMarkerId(a,function(){b()})},this.saveImage=function(a,b,c){e.saveFile(a,function(a){b(a)},function(a){c(a)})},this.saveImageByBase64=function(a,b,c,d){e.saveBase64File(a,b,function(a){c(a)},function(a){d(a)})},this.resetModels=function(){a=new Array,b=new Array,c=new Array},this.getModelMarkers=function(){return a},this.fetchMaxIdinMarks=function(){return a.sort(function(a,b){return a.id>b.id?1:a.id==b.id?0:-1}),a[a.length-1].id},this.createOneMarker=function(b,c){var d=new MapMarker(b);return $.publish("createOneMarker",[d]),null!=c&&(d.content.updateContent(c),d.updateOffset(c.offsetX,c.offsetY)),a.push(d),d},this.createOverviewMarker=function(a,b,d){var e=new MapMarker(a);return e.routineId=d,$.publish("createOverViewMarker",[e,b]),null!=b&&(e.content.updateContent(b),e.updateOffset(b.offsetX,b.offsetY)),c.push(e),e},this.deleteOvMarker=function(a){var e,d=this.getMapMarkerById(a);if(d.content.isAvergeOverViewMarker())return alert("this marker can not be deleted"),void 0;for(e in c)c[e].id==a&&c.splice(e,1);if(0!=b.length)for(e in b)b[e].id==a&&b.splice(e,1);$.publish("deleteOvMarker",[a]),$.publish("updateOvLines")},this.deleteOneMarker=function(b,c){var f,g,h,d=this.getMapMarkerById(b);if(null!=d){null!=d.prevMainMarker&&d.prevMainMarker.disconnectNextMarker(),null!=d.connectedMainMarker&&d.disconnectNextMarker(),null!=d.parentSubMarker&&d.parentSubMarker.disconnectTreeChildMarker(d),d.disconnectAllTreeChildMarker();for(f in a)a[f].id==b&&a.splice(f,1);if(c&&(g=d.content.getImgUrls(),null!=g&&g.length>0))for(f in g)h=g[f],e.deleteFileByUrl(h,function(){console.log("success deleted img ")},function(){console.log("fail delete img")});$.publish("deleteOneMarker",[d])}},this.isUserOwnRoutine=function(a,b){var c=e.getCurrentUser();e.isUserOwnRoutines(c,a,b)},this.loadAllOverviewRoutine=function(a){c=new Array;var b=e.getCurrentUser();e.fetchOverviewRoutinesByUser(b,function(b){var c,e,f,g;for(c in b){e=b[c].overviewJSONString,f=b[c].routineId,g=JSON.parse(e);for(c in g)d.createOverviewMarker(g[c].id,g[c],f)}a()})},this.loadRoutineByOverviewMarkerId=function(b,c){a=new Array,e.fetchRoutineJSONStringByOverviewMarkerId(b,function(a,b){var e,f,g,h;if(null!=a){e=JSON.parse(a);for(f in e)d.createOneMarker(e[f].id,e[f]);for(f in e){g=e[f];for(h in g.subMarkerIds)d.addSubLine(g.id,g.subMarkerIds[h],0,0)}}c(b)})},this.loadRoutine=function(b,c){a=new Array,e.fetchRoutineJSONStringById(b,function(a,b,e){var f,g,h,i,j;if(null!=e){f=JSON.parse(e);for(g in f)d.createOverviewMarker(f[g].id,f[g])}if(null!=a){h=JSON.parse(a);for(g in h)d.createOneMarker(h[g].id,h[g]);for(g in h){i=h[g];for(j in i.subMarkerIds)d.addSubLine(i.id,i.subMarkerIds[j],0,0)}}console.log("model.loadRoutine:fetch routine success"),c({routineName:b})})},this.save2Backend=function(a,b){var d,g,h,i,j;if(console.log("prepare to save routine "+a),d=e.getCurrentUser(),null==d)return alert("no find user abort saving routine"),void 0;g={};for(h in c)i=c[h],i.routineId in g?g[i.routineId].push(i.toJSONObject()):(g[i.routineId]=new Array,g[i.routineId].push(i.toJSONObject()));for(j in g)g[j]=JSON.stringify(g[j]);e.updateAllOverviews(g,function(){f(a,function(){b()})})},this.getMapMarkerById=function(a){var d,e,b=h(a);if(null==b){for(d=c.length,e=0;d>e;e++)if(c[e].id==a)return c[e];return alert("can not find model marker :"+a),null}return b},this.getMarkerContentById=function(a){var b=this.getMapMarkerById(a);return null!=b.getContent()?b.getContent():null},this.addMainLine=function(a,b){var c=h(a),d=h(b);c.addNextMarker(d)},this.addSubLine=function(a,b){var c,d;console.log("model.addSubLine: fromId: "+a+" toId "+b),c=h(a),d=h(b),c.addTreeChildMarker(d)},this.findHeadMarker=function(){var d,b=new Array,c=a.length;for(d=0;c>d;d++)a[d]instanceof MapMarker&&(null!=a[d].prevMainMarker||a[d].isSubMarker()||b.push(a[d]));return b},this.belongWhichHeadIds=function(a){var c,d,b=this.getMapMarkerById(a);if(null==b.prevMainMarker){c=[],d=b;do c.push(d.id),d=d.connectedMainMarker;while(null!=d);return console.log("model.belongwhichHeadIds: return "+c),c}return this.belongWhichHeadIds(b.prevMainMarker.id)},this.redrawConnectedLine=function(a){var b=h(a);null!=b.prevMainMarker&&i(b.prevMainMarker),i(b),null!=b.parentSubMarker&&j(b.parentSubMarker),j(b)}}function BackendManager(){var a=AV.Object.extend("Routine"),b=null,c=null,d=null;AV.initialize("6pzfpf5wkg4m52owuwixt5vggrpjincr8xon3pd966fhgj3c","4wrzupru1m4m7gpafo4llinv7iepyapnycvxygup7uiui77x"),this.login=function(a,b,c){AV.User.logIn(a,b,{success:function(a){c(a)},error:function(){alert("login failed")}})},this.getCurrentUser=function(){return(c=AV.User.current())?(console.log("welcomse session user:"+c.get("username")),c):(AV.User.logIn("guest","guest",{success:function(a){return console.log("login for user:"+a.get("username")),c=a},error:function(a,b){return alert("Error: "+b.code+" "+b.message),alert("log failed. abort save routines"),null}}),void 0)},this.fetchRoutinesByUser=function(b,c){var d=new AV.Query(a);d.equalTo("user",b),d.find({success:function(a){console.log("backendManager:fetch routine success"),c(a)}})},this.fetchOverviewRoutinesByUser=function(b,c){var e=new AV.Query(a);e.equalTo("user",b),e.select("title","overViewJSONString"),e.find({success:function(a){var b,e;console.log("backendManager:fetchOverviewRoutinesByUser success"),d=a,b=[];for(e in a)b.push({routineId:a[e].id,overviewJSONString:a[e].get("overViewJSONString")});c(b)}})},this.deleteRoutineByOverviewMarkerId=function(a,b){var c,e;for(c in d)e=d[c].get("overViewJSONString"),-1!=e.indexOf(a)&&d[c].destroy({success:function(){b()}})},this.fetchRoutineJSONStringByOverviewMarkerId=function(a,c){var e,f,g,h;if(null==d)return c(null);for(e in d)if(f=d[e].get("overViewJSONString"),-1!=f.indexOf(a)){if(b=d[e],g=d[e].get("RoutineJSONString"),h=d[e].get("title"),null!=g)return c(g,h);d[e].fetch().then(function(a){var b=a.get("RoutineJSONString");c(b,h)})}},this.isUserOwnRoutines=function(b,c,d){var e=new AV.Query(a);e.equalTo("user",b),e.get(c,{success:function(){console.log("BackManager.isUserOwnRoutines: user own this routine"),d(!0)},error:function(){console.log("BackManager.isUserOwnRoutines: user not own this routine"),d(!1)}})},this.fetchRoutineJSONStringById=function(c,d){console.log("BackendManager.FetchRoutineJSONStringById-fetch routine id=:"+c);var e=new AV.Query(a);e.get(c,{success:function(a){b=a,d(b.get("RoutineJSONString"),b.get("title"),b.get("overViewJSONString"))},error:function(a,b){alert("The object was not retrieved successfully."),console.log(b)}})},this.updateAllOverviews=function(a,b){var c,e,f;for(c in a)if(e=c,null!=e)for(f in d)d[f].id==e&&d[f].set("overViewJSONString",a[c]);AV.Object.saveAll(d,{success:function(){console.log("update all overviews success"),b()},error:function(a){console.log("error happenned when update all overview"+a)}})},this.saveRoutine=function(c,d,e,f){null==b&&(b=new a),b.set("title",c),b.set("RoutineJSONString",d),b.set("user",this.getCurrentUser()),b.set("overViewJSONString",e),b.save(null,{success:function(a){b=a,f()},error:function(){alert("save routine failed"),b=null}})},this.saveFile=function(a,b,c){var d=a.name,e=new AV.File(d,a);e.save().then(function(){b(e.url())},function(a){c(a)})},this.saveBase64File=function(a,b,c,d){var e=new AV.File(b,{base64:a});e.save().then(function(){c(e.url())},function(a){d(a)})},this.deleteFileByUrl=function(a,b,c){console.log("BManager.deleteFileByUrl:"+a);var d=new AV.Query(AV.Object.extend("_File"));d.equalTo("url",a),d.find({success:function(d){if(d.length>0){console.log("find url:"+a);var e=d[0];e.destroy({success:function(){b()},error:function(a){console.log("Error: "+a.code+" "+a.message),c()}})}else console.log("url "+a+" not found")},error:function(a){console.log("Error: "+a.code+" "+a.message),c()}})}}function MarkerContent(a){var b,c,d,e,f,g,h,i,j,k,l,m,n;this.id=a,b="Unknown Location",c="Unknown Address",d=0,e=0,f="...",g="marker",h=new Array,i=!0,j=1,k=!1,l="resource/icons/pic/pic_default.png",m="resource/icons/pic/pic_no_position.png",n="resource/icons/default/default_default.png",this.isAvergeOverViewMarker=function(){return k},this.setIsAvergeOverViewMarker=function(a){k=a},this.getSlideNum=function(){return j},this.setSlideNum=function(a){j=a},this.setImgPositionDecided=function(a){i=a,i?this.setIconUrl(l):this.setIconUrl(m)},this.isImgPositionDecided=function(){return i},this.updateContent=function(a){null!=a.slideNum&&this.setSlideNum(a.slideNum),null!=a.title&&this.setTitle(a.title),null!=a.address&&this.setAddress(a.address),null!=a.mycomment&&this.setMycomment(a.mycomment),null!=a.category&&this.setCategory(a.category),null!=a.lat&&null!=a.lng&&this.setlatlng(a.lat,a.lng),null!=a.imgUrls&&0!=a.imgUrls.length&&this.setImgUrls(a.imgUrls),null!=a.iconUrl&&this.setIconUrl(a.iconUrl),null!=a.isAverage&&this.setIsAvergeOverViewMarker(a.isAverage),$.publish("updateInfoWindow",[this])},this.addImgUrl=function(a){h.push(a),$.publish("updateInfoWindow",[this])},this.getIconUrl=function(){return n},this.setIconUrl=function(a){n=a,$.publish("iconUrlUpdated",[this])},this.getImgUrls=function(){return h},this.setImgUrls=function(a){h=a},this.getCategory=function(){return g},this.setCategory=function(a){g=a},this.getLat=function(){return d},this.setlatlng=function(a,b){d=a,e=b,$.publish("latlngChanged",[this]),$.publish("updateUI",[])},this.getLng=function(){return e},this.getAddress=function(){return c},this.setAddress=function(a){c=a},this.getTitle=function(){return b},this.setTitle=function(a){b=a},this.setMycomment=function(a){f=a},this.getMycomment=function(a){return a?f.substring(0,150)+"...":f}}function MapMarker(a){this.id=a,this.content=new MarkerContent(a),this.needMainLine=!1,this.needSubLine=!1,this.connectedMainMarker=null,this.connectedMainLine=null,this.mainPaths=new Array,this.prevMainMarker=null,this.subMarkersArray=new Array,this.parentSubMarker=null,this.isHideAllSubMarkers=!1,this.offsetX=0,this.offsetY=0,this.isSubMarker=function(){return null!=this.parentSubMarker?!0:!1},this.updateOffset=function(a,b){console.log("id "+this.id+" modelMarker.updateOffset: "+a+" "+b),this.offsetX=a,this.offsetY=b},this.canAddSubMarker=function(a){var b=!0;return b=null!=a.parentSubMarker||null!=a.connectedMainMarker||null!=a.prevMainMarker||this.isSubMarker()?!1:!0},this.addNextMarker=function(a){a.isSubMarker()||(null!=this.connectedMainMarker&&(this.connectedMainMarker.prevMainMarker=null),this.connectedMainMarker=a,a.prevMainMarker=this,$.publish("updateUI",[]))},this.disconnectNextMarker=function(){null!=this.connectedMainMarker&&(this.connectedMainMarker.prevMainMarker=null,this.connectedMainMarker=null)},this.addTreeChildMarker=function(a){this.canAddSubMarker(a)&&(this.subMarkersArray.push(a),a.parentSubMarker=this,$.publish("updateUI",[]))},this.disconnectTreeChildMarker=function(a){if(0!=this.subMarkersArray.length){for(var b in this.subMarkersArray)this.subMarkersArray[b].id==a.id&&(this.subMarkersArray[b].parentSubMarker=null,this.subMarkersArray.splice(b,1));console.log(this.subMarkersArray)}},this.disconnectAllTreeChildMarker=function(){if(0!=this.subMarkersArray.length){for(var a in this.subMarkersArray)this.subMarkersArray[a].parentSubMarker=null;this.subMarkersArray=new Array}},this.toJSONObject=function(){var b,c,a=new Array;for(b in this.subMarkersArray)a.push(this.subMarkersArray[b].id);return c={id:this.id,lat:this.getContent().getLat(),lng:this.getContent().getLng(),title:this.getContent().getTitle(),address:this.getContent().getAddress(),mycomment:this.getContent().getMycomment(!1),category:this.getContent().getCategory(),imgUrls:this.getContent().getImgUrls(),iconUrl:this.getContent().getIconUrl(),slideNum:this.getContent().getSlideNum(),nextMainMarkerId:null==this.connectedMainMarker?null:this.connectedMainMarker.id,subMarkerIds:a,mainPaths:this.mainPaths,offsetX:this.offsetX,offsetY:this.offsetY,isAverage:this.getContent().isAvergeOverViewMarker()}},this.getContent=function(){return this.content}}function MainLine(a){this.id=a}function SubLine(a){this.id=a}