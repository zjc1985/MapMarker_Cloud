function MapController(){function j(){var f,g,d=[];for(f in a.getModelMarkers())g=a.getModelMarkers()[f],g.content.getSlideNum()<e-1&&!g.isSubMarker()&&d.push(g.id);d.length>0&&(b.clearMarkerCluster(),b.AddMarkers2Cluster(d))}function k(c){var e,f,g,d=a.getMapMarkerById(c);if(0!=d.subMarkersArray.length){e=!1;for(f in d.subMarkersArray)g=b.getViewOverlaysById(d.subMarkersArray[f].id),null==g.isShow||0==g.isShow?(b.setMarkerZIndex(g.id,h),g.show(),b.setMarkerAnimation(d.subMarkersArray[f].id,"BOUNCE"),e=!0):g.hide(),e&&setTimeout(function(){for(var a in d.subMarkersArray)b.setMarkerAnimation(d.subMarkersArray[a].id,null)},750)}}function m(c){var e,d=a.getMapMarkerById(c);if(0!=d.subMarkersArray.length)for(e=0 in d.subMarkersArray)b.drawSubLine(c,d.subMarkersArray[e].id),m(d.subMarkersArray[e].id)}function n(a,c){var d=new Object,e=b.getViewOverlaysById(a),f=b.getViewOverlaysById(c),g=b.fromLatLngToPixel(e.getLatLng()),h=b.fromLatLngToPixel(f.getLatLng());return d.offsetX=h.x-g.x,d.offsetY=h.y-g.y,d}function o(){var d,e,c=new Array;for(d in a.getModelMarkers())e=a.getModelMarkers()[d],e.isSubMarker()||c.push(e.id);b.clearMarkerCluster(),b.AddMarkers2Cluster(c)}var d,e,f,g,h,i,a=new MapMarkerModel,b=new GoogleMapView(this),c=this;b.createView(),d=!1,e=1,f=!1,g=!1,h=200,i="Default Routine",this.deleteOvMarker=function(b){a.deleteOvMarker(b)},this.addOvMarker=function(b,c){var d=a.genUUID(),e=a.getMapMarkerById(c),f=e.routineId;b.isAverage=!1,b.title=e.content.getTitle(),b.mycomment=e.content.getMycomment(!1),a.createOverviewMarker(d,b,f)},this.deleteRoutine=function(b){var d=confirm("Are you sure you want to delete this routine?");1==d&&a.deleteRoutineByOverviewId(b,function(){alert("delete routine success"),c.loadRoutines()})},this.showRoutineDetail=function(c){for(var d in a.getModelMarkers())b.removeById(a.getModelMarkers()[d].id);a.setCurrenOverviewMarkersByOverviewId(c),a.loadRoutineByOverviewMarkerId(c,function(c){var d,e,f;i=c,d=[];for(e in a.getModelMarkers())f=a.getModelMarkers()[e].id,k(f),d.push(f);b.fitBoundsByIds(d)})},this.uploadImgs=function(d,e,f,g){a.saveImageByBase64(d,g,function(d){var g,h,i;b.uploadImgForm.completeFileNum++,b.uploadImgForm.updateProgress(),g=!0,(null==e||null==f)&&(g=!1,e=b.getCenter().lat,f=b.getCenter().lng),h=c.addMarkerClickEvent({lat:e,lng:f},{imgUrls:[d],title:file.name}),i=a.getMarkerContentById(h),i.setImgPositionDecided(g),b.uploadImgForm.completeFileNum==b.uploadImgForm.fileNum&&(alert("all save complete"),b.uploadImgForm.UIFinishUpload(),b.uploadImgForm.close(),b.fitRoutineBounds())},function(a){b.uploadImgForm.completeFileNum++,b.uploadImgForm.updateProgress(),alert("one save failed"+a)})},this.searchLocation=function(a){b.searchLocation(a)},this.startSlideMode=function(){var c,f;d=!0,e=1,b.infocard.hideEditButton(),b.removeAllLines(),b.initSlideMode(),b.clearMarkerCluster();for(c in a.getModelMarkers())f=b.getViewOverlaysById(a.getModelMarkers()[c].id),f.hide()},this.exitSlideMode=function(){var c,e;if(g){d=!1,b.infocard.showEditButton(),b.removeAllLines(),b.exitSlideMode();for(c in a.getModelMarkers())e=b.getViewOverlaysById(a.getModelMarkers()[c].id),a.getModelMarkers()[c].isSubMarker()?e.hide():e.show();o()}},this.prevSlide=function(){var c,f,g;if(d){for(c in a.getModelMarkers())f=a.getModelMarkers()[c],(f.content.getSlideNum()==e-1||f.content.getSlideNum()==e-2)&&(g=b.getViewOverlaysById(f.id),g.hide());e<=a.getModelMarkers().length&&(e--,e--,j(e))}},this.mapClickEventHandler=function(){var c,f,g,h;if(d){if(e>a.getModelMarkers().length)return;c=[];for(f in a.getModelMarkers())g=a.getModelMarkers()[f],g.content.getSlideNum()!=e||g.isSubMarker()||c.push(g.id);e++,c.length>0?(b.panByIds(c),j(e-1),h=700,setTimeout(function(){var a,d;for(a in c)d=c[a],b.setMarkerZIndex(d,e),b.getViewOverlaysById(d).show(),b.setMarkerAnimation(d,"DROP")},h),setTimeout(function(){var a,d;for(a in c)d=c[a],b.setMarkerAnimation(d,"BOUNCE")},h+650),setTimeout(function(){var a,d;for(a in c)d=c[a],b.setMarkerAnimation(d,null)},h+2900)):this.mapClickEventHandler()}},this.zoomEventHandler=function(){var c,d,e,g,h,i,j,k,l;for(c in a.getModelMarkers())d=a.getModelMarkers()[c],d.isSubMarker()&&(e=b.getViewOverlaysById(d.parentSubMarker.id),g=b.fromLatLngToPixel(e.getLatLng()),h=g,h.x=h.x+d.offsetX,h.y=h.y+d.offsetY,i=b.fromPixelToLatLng(h),console.log("calculate newlatlng "+i),d.content.updateContent(i));if(b.isInCustomZoom()){if(!f){$.publish("updateOvLines"),b.clearMarkerCluster(),b.setMapStyle2Custom(),j=a.getAllOverviewMarkers();for(c in j)k=b.getViewOverlaysById(j[c].id),k.show();l=a.getModelMarkers();for(c in l)k=b.getViewOverlaysById(l[c].id),k.hide()}f=!0}else{if(f){b.removeAllOvLines(),o(),b.setMapStyle2Default(),j=a.getAllOverviewMarkers();for(c in j)k=b.getViewOverlaysById(j[c].id),k.hide();l=a.getModelMarkers();for(c in l)l[c].isSubMarker()||(k=b.getViewOverlaysById(l[c].id),k.show())}f=!1}},this.updateMarkerContentById=function(b,c){var e,f,g,d=a.getMapMarkerById(b);if(a.isOvMarker(b)){d.content.updateContent(c),e=a.getAllOverviewMarkers();for(f in e)e[f].routineId==d.routineId&&(g={title:c.title,mycomment:c.mycomment},e[f].content.updateContent(g))}else if(d.content.updateContent(c),null!=c.slideNum&&d.subMarkersArray.length>0)for(f in d.subMarkersArray)d.subMarkersArray[f].content.updateContent({slideNum:c.slideNum})},this.showAllRoutineClickHandler=function(){b.showAllMarkers(),$.publish("updateUI",[])},this.showInfoClickHandler=function(c){var d=a.getMarkerContentById(c);console.log("controller.showInfoClickHandler: "+d.getTitle()+d.getAddress()+d.getCategory()+d.getMycomment(!1)),b.infocard.setMaxSlideNum(a.getModelMarkers().length),b.infocard.setDefaultContent({title:d.getTitle(),iconUrl:d.getIconUrl(),address:d.getAddress(),category:d.getCategory(),mycomment:d.getMycomment(!0),slideNum:d.getSlideNum(),fullcomment:d.getMycomment(!1)}),b.infocard.setDefaultImgs(d.getImgUrls()),0!=d.getImgUrls().length?b.infocard.showContentB():b.infocard.showContentA()},this.lineEditEnd=function(b,c){console.log("line editend, line node num: "+b.length),console.log("from marker id:"+c);var d=a.getMapMarkerById(c);d.mainPaths=b},this.overviewMarkerClickEventHandler=function(c){var d,e,f,g;b.infocard.show(),b.currentMarkerId=c,this.showInfoClickHandler(c),d=a.getMapMarkerById(c).routineId,e=a.getAllOverviewMarkers(),f=[];for(g in e)e[g].routineId==d&&(f.push(e[g].id),b.setMarkerAnimation(e[g].id,"BOUNCE"));setTimeout(function(){var a,c;for(a in f)c=f[a],b.setMarkerAnimation(c,null)},1950)},this.markerClickEventHandler=function(c){var d,e,f,g,i,j,l,m,n;if(b.infocard.show(),b.currentMarkerId=c.id,null!=b.markerNeedMergeImgUrl){if(b.markerNeedMergeImgUrl.id!=c.id){d=a.getMarkerContentById(b.markerNeedMergeImgUrl.id),e=d.getImgUrls(),f=a.getMarkerContentById(c.id);for(g in e)f.addImgUrl(e[g])}return b.markerNeedMergeImgUrl=null,void 0}return null!=b.markerNeedMainLine?(a.addMainLine(b.markerNeedMainLine.id,c.id),b.markerNeedMainLine=null,void 0):null!=b.markerNeedSubLine?(i=b.fromLatLngToPixel(b.markerNeedSubLine.getLatLng()),j=b.fromLatLngToPixel(c.getLatLng()),l=j.x-i.x,m=j.y-i.y,a.getMapMarkerById(c.id).updateOffset(l,m),a.addSubLine(b.markerNeedSubLine.id,c.id),b.markerNeedSubLine=null,void 0):(n=a.getMapMarkerById(c.id),null!=n.connectedMainMarker&&b.fitTwoPositionBounds({lat:n.content.getLat(),lng:n.content.getLng()},{lat:n.connectedMainMarker.content.getLat(),lng:n.connectedMainMarker.content.getLng()}),0!=a.getMapMarkerById(c.id).subMarkersArray.length&&k(c.id),this.showInfoClickHandler(c.id),b.setMarkerZIndex(c.id,h),$.publish("updateUI",[]),void 0)},this.viewMarkerDragendEventHandler=function(b,c,d){var e=a.getMapMarkerById(b);e.content.updateContent({lat:c,lng:d}),$.publish("updateOvLines")},this.markerDragendEventHandler=function(c,d,e){var g,h,i,j,k,f=a.getMapMarkerById(c);if(f.content.updateContent({lat:d,lng:e}),f.content.isImgPositionDecided()||f.content.setImgPositionDecided(!0),f.isSubMarker())g=n(f.parentSubMarker.id,c),f.updateOffset(g.offsetX,g.offsetY);else if(f.subMarkersArray.length>0){h=b.fromLatLngToPixel({lat:d,lng:e});for(i in f.subMarkersArray)j=new google.maps.Point(h.x,h.y),j.x=j.x+f.subMarkersArray[i].offsetX,j.y=j.y+f.subMarkersArray[i].offsetY,k=b.fromPixelToLatLng(j),f.subMarkersArray[i].content.updateContent(k)}},this.addMarkerClickEvent=function(b,c){var d,e;return c.lat=b.lat,c.lng=b.lng,d=a.genUUID(),e=a.createOneMarker(d,c).id,console.log("creating markder id:"+e),e},this.markerDeleteClickHandler=function(b){a.deleteOneMarker(b.id,!0)},this.addCustomClickEvent=function(a){b.addCustomOverlay(a)},this.addMainLineClickHandler=function(a){b.markerNeedMainLine=a,alert("please click another marker to add main line")},this.addSubLineClickHandler=function(a){b.markerNeedSubLine=a,alert("please click another marker to add sub line")},this.mergeImgUrlClickHandler=function(a){b.markerNeedMergeImgUrl=a,alert("please click another marker which you want to merge to")},this.loadRoutines=function(){a.resetModels(),b.resetView(),a.loadAllOverviewRoutine(function(){b.fitRoutineBounds(),b.setMapZoom(5),c.zoomEventHandler()})},this.saveRoutine=function(){if("Default Routine"!=i||0==a.getModelMarkers().length)a.save2Backend(i,function(){alert("save success"),c.loadRoutines()});else{var b=prompt("routine name?",i);null!=b&&""!=b?a.save2Backend(b,function(){alert("save success"),c.loadRoutines()}):alert("please input your routine name to save")}},this.testFeature=function(){},this.iconUrlUpdatedHandler=function(){return function(a,c){console.log("controller.iconUrlUpdatedHandler:"+c.getIconUrl()),b.changeMarkerIcon(c.id,c.getIconUrl())}},this.deleteViewMarker=function(){return function(a,c){b.removeById(c.id),b.infocard.hide(),$.publish("updateUI",[])}},this.deleteViewOvMarker=function(){return function(a,c){b.removeById(c),b.infocard.hide()}},this.latlngChangedHandler=function(){return function(a,c){var d,e;console.log("controller.updateUIMarker"),d=b.getViewOverlaysById(c.id),null!=d&&(e=new google.maps.LatLng(c.getLat(),c.getLng()),d.setPosition(e))}},this.createViewMarker=function(){return function(a,c){b.addOneMark(c.content.getLat(),c.content.getLng(),c.id),b.changeMarkerIcon(c.id,c.content.getIconUrl())}},this.createOverviewMarker=function(){return function(a,c,d){var e={};e.needDrag=d.isAverage?!1:!0,b.addOverviewMarker(c.content.getLat(),c.content.getLng(),c.id,e),d.isAverage&&b.setMarkerZIndex(c.id,0),b.changeMarkerIcon(c.id,c.content.getIconUrl())}},this.updateOvLines=function(){return function(){var d,e,f,g,h,i;if(b.isInCustomZoom()){b.removeAllOvLines(),d=a.getAllOverviewMarkers();for(e in d)f=d[e],f.content.isAvergeOverViewMarker()||(g=a.findAverageOvMarkerByOvId(f.id),null!=g&&(h={lat:g.content.getLat(),lng:g.content.getLng()},i={lat:f.content.getLat(),lng:f.content.getLng()},b.drawOvLine(h,i)))}else b.removeAllOvLines()}},this.updateUIRoute=function(){return function(){var d,e,f,g;for(console.log("controller.updateUIRoute"),b.removeAllLines(),d=a.findHeadMarker(),e=0;e<d.length;e++)for(f=d[e],m(f.id);null!=f.connectedMainMarker;){for(1==b.getViewOverlaysById(f.connectedMainMarker.id).isShow&&b.drawMainLine(f.id,f.connectedMainMarker.id,0,0==f.mainPaths.length?null:f.mainPaths),g=0;g<f.connectedMainMarker.subMarkersArray.length;g++)b.drawSubLine(f.connectedMainMarker.id,f.connectedMainMarker.subMarkersArray[g].id);f=f.connectedMainMarker}}},this.updateMarkerInfoWindow=function(){return function(a,c){var d=b.getViewOverlaysById(c.id),e=c;console.log("update marker info window. markerId: "+c.id),console.log("title: "+e.getTitle()),null!=d&&(b.infocard.setDefaultContent({title:e.getTitle(),address:e.getAddress(),slideNum:e.getSlideNum(),mycomment:e.getMycomment(!0),category:e.getCategory(),fullcomment:e.getMycomment(!1)}),b.infocard.setDefaultImgs(e.getImgUrls()),null!=d.infoWindow&&d.infoWindow.setContent(e.getTitle()))}},$.subscribe("deleteOvMarker",this.deleteViewOvMarker()),$.subscribe("deleteOneMarker",this.deleteViewMarker()),$.subscribe("createOneMarker",this.createViewMarker()),$.subscribe("createOverViewMarker",this.createOverviewMarker()),$.subscribe("updateOvLines",this.updateOvLines()),$.subscribe("updateUI",this.updateUIRoute()),$.subscribe("updateInfoWindow",this.updateMarkerInfoWindow()),$.subscribe("latlngChanged",this.latlngChangedHandler()),$.subscribe("iconUrlUpdated",this.iconUrlUpdatedHandler())}var QueryString=function(){var d,e,f,a={},b=window.location.search.substring(1),c=b.split("&");for(d=0;d<c.length;d++)e=c[d].split("="),"undefined"==typeof a[e[0]]?a[e[0]]=e[1]:"string"==typeof a[e[0]]?(f=[a[e[0]],e[1]],a[e[0]]=f):a[e[0]].push(e[1]);return a}();